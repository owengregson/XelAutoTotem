name: Java CI with Gradle

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for creating releases

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up JDK 22
      uses: actions/setup-java@v4
      with:
        java-version: '22'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Extract current version from gradle.properties
      id: get_version
      run: |
        version=$(grep -oP '(?<=mod_version = ).*' gradle.properties)
        echo "mod_version=$version" >> $GITHUB_ENV

    - name: Check if version has changed
      id: version_check
      run: |
        git fetch --tags
        current_version="${{ env.mod_version }}"
        previous_version=$(git describe --tags --abbrev=0 || echo "none")
        
        if [ "$previous_version" = "none" ]; then
          echo "No previous version found. Proceeding with build."
          echo "build_required=true" >> $GITHUB_ENV
        else
          echo "Previous version: $previous_version"
          if [ "$current_version" != "$previous_version" ]; then
            echo "Version has changed. Proceeding with build."
            echo "build_required=true" >> $GITHUB_ENV
          else
            echo "Version has not changed. Skipping build."
            echo "build_required=false" >> $GITHUB_ENV
          fi
        fi

    - name: Build with Gradle
      if: env.build_required == 'true'
      run: ./gradlew build

    - name: Create GitHub Release
      if: env.build_required == 'true' && github.ref == 'refs/heads/main'
      run: |
        changelog=$(git log $(git describe --tags --abbrev=0 @^)..@ --pretty=format:"%h - %s")
        tag_name=${{ env.mod_version }}
        release_name="${{ env.mod_version }}"

        gh release create $tag_name --title "$release_name" --notes "$changelog" --target main

    - name: Upload JAR to Release
      if: env.build_required == 'true' && github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.version_check.outputs.upload_url }}
        asset_path: ./build/libs/XAT-${{ env.mod_version }}.jar  # Only the main JAR file
        asset_name: "XAT-${{ env.mod_version }}.jar"
        asset_content_type: application/java-archive
